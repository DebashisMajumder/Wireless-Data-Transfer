{% extends "base.html" %}

{% block title %}üîí Secure Files{% endblock %}

{% block meta %}
<meta http-equiv="Cache-Control" content="no-store">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block styles %}
<style>
    .secure-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px 20px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
    }
    
    .secure-header h1 {
        font-size: 28px;
        margin-bottom: 8px;
        color: var(--accent);
    }
    
    .secure-header p {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .token-display {
        display: inline-block;
        background: var(--bg);
        padding: 8px 16px;
        border-radius: 8px;
        font-family: monospace;
        margin-top: 8px;
        border: 1px solid var(--border);
    }
    
    .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
    }
    
    .file-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s;
    }
    
    .file-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .file-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .file-icon {
        width: 40px;
        height: 40px;
        background: rgba(61, 220, 151, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .file-info {
        flex: 1;
        min-width: 0;
    }
    
    .file-name {
        font-weight: 600;
        word-break: break-word;
        margin-bottom: 4px;
        color: var(--accent);
        text-decoration: none;
        display: block;
    }
    
    .file-name:hover {
        text-decoration: underline;
    }
    
    .file-meta {
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .expiry {
        color: var(--warning);
        font-weight: 600;
    }
    
    .expiry.critical {
        color: var(--danger);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .file-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .file-actions form {
        flex: 1;
    }
    
    .file-actions button {
        width: 100%;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }
    
    .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 16px;
        opacity: 0.3;
    }
    
    .footer-info {
        margin-top: 30px;
        text-align: center;
        padding: 20px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    @media (max-width: 768px) {
        .files-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="secure-header">
        <h1>üîí Secure Files</h1>
        <p>Files accessible via this secure link</p>
        <div class="token-display">Token: {{ token }}</div>
    </div>
    
    <!-- Files -->
    {% if files %}
        <div class="files-grid">
            {% for file in files %}
            <div class="file-card">
                <div class="file-header">
                    <div class="file-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z" stroke-width="2"/>
                            <polyline points="13 2 13 9 20 9" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="file-info">
                        <a href="/secure_download/{{ token }}/{{ file.name }}" class="file-name">
                            {{ file.name }}
                        </a>
                        <div class="file-meta">
                            <span>üì¶ {{ file.size }}</span>
                            <span>üìÖ {{ file.uploaded }}</span>
                            <span class="expiry" data-seconds="{{ file.expires_in }}">
                                ‚è± Calculating...
                            </span>
                        </div>
                    </div>
                </div>
                <div class="file-actions">
                    <form method="post" 
                          action="/secure_delete/{{ token }}/{{ file.name }}" 
                          onsubmit="return confirm('Delete this file? This action cannot be undone.')">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 2a10 10 0 100 20 10 10 0 000-20z" stroke-width="2"/>
                <line x1="15" y1="9" x2="9" y2="15" stroke-width="2" stroke-linecap="round"/>
                <line x1="9" y1="9" x2="15" y2="15" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <h3>No Files Available</h3>
            <p>This secure link may have expired or all files have been deleted.</p>
        </div>
    {% endif %}
    
    <!-- Footer Info -->
    <div class="footer-info">
        <strong>üîí Secure File Transfer</strong><br>
        Files automatically expire after 24 hours<br>
        Only accessible via this unique link
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatTime(seconds) {
        if (seconds <= 0) return '‚è± Expired';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let timeStr = '‚è± ';
        if (hours > 0) timeStr += hours + 'h ';
        if (minutes > 0) timeStr += minutes + 'm ';
        timeStr += secs + 's';
        
        return timeStr;
    }
    
    // Update expiry timers
    document.querySelectorAll('.expiry').forEach(el => {
        let remaining = parseInt(el.dataset.seconds);
        
        function updateExpiry() {
            el.textContent = formatTime(remaining);
            
            // Add critical class if less than 1 hour
            if (remaining < 3600) {
                el.classList.add('critical');
            }
            
            remaining--;
            
            if (remaining < 0) {
                setTimeout(() => location.reload(), 1000);
            }
        }
        
        updateExpiry();
        setInterval(updateExpiry, 1000);
    });
</script>
{% endblock %}